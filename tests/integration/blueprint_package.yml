# Copyright 2017 CenturyLink
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Test clc_publicip.py Ansible Module
  hosts: localhost
  vars:
    location: 'CA3'
    group_name: 'Ansible Module Test'
    server_name: 'AnsTst'
    server_template: 'CENTOS-7-64-TEMPLATE'
    loadbalancer_name: 'Ansible Module Test'
  gather_facts: False
  connection: local
  tasks:
    - name: Setup - Ensure group present
      clc_group:
        location: "{{ location }}"
        name: "{{ group_name }}"
        state: present

    - name: Setup - Ensure 1 server exist in group
      clc_server:
        name: "{{ server_name }}"
        template: "{{ server_template }}"
        location: "{{ location }}"
        group: "{{ group_name }}"
        count_group: "{{ group_name }}"
        min_count: 1
      register: group_info


    - name: Setup - Server information
      clc_server_fact:
        server_id: "{{ group_info.group.servers[0] }}"
      register: server_info


    - name: Test - Install Ansible on CentOS
      clc_blueprint_package:
        server_ids:
          - "{{ server_info.server.id }}"
        package_id: a103ec29-b590-4374-8b89-378965837abd
        state: present
        wait: True
      register: blueprint_ansible
    - name: Debug
      debug:
        var: blueprint_ansible

    - name: Test - Install (Fake) SSH Public Key on Linux
      clc_blueprint_package:
        server_ids:
            - "{{ server_info.server.id }}"
        package_id: 77abb844-579d-478d-3955-c69ab4a7ba1a
        package_params: {'User': 'root', 'SshKey': 'ssh-rsa AAAABO_fake_key_L0x bb@machine.local'}
        wait: True
        state: present
      register: blueprint_ssh
    - name:
      debug:
        var: blueprint_ssh


    - name: Tear Down - Ensure 0 servers exist in group
      clc_server:
        name: "{{ server_name }}"
        template: "{{ server_template }}"
        location: "{{ location }}"
        group: "{{ group_name }}"
        count_group: "{{ group_name }}"
        exact_count: 0

    - name: Tear Down - Ensure group absent
      clc_group:
        location: "{{ location }}"
        name: "{{ group_name }}"
        state: absent
