# Copyright 2017 CenturyLink
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Test clc_server_snapshot.py Ansible Module
  hosts: localhost
  vars:
    location: 'CA3'
    group_name: 'Ansible Module Test'
    server_name: 'AnsTst'
    server_template: 'CENTOS-7-64-TEMPLATE'
    loadbalancer_name: 'Ansible Module Test'
  gather_facts: False
  connection: local
  tasks:
    - name: Setup - Ensure group present
      clc_group:
        location: "{{ location }}"
        name: "{{ group_name }}"
        state: present

    - name: Setup - Ensure 1 server exist in group
      clc_server:
        name: "{{ server_name }}"
        template: "{{ server_template }}"
        location: "{{ location }}"
        group: "{{ group_name }}"
        count_group: "{{ group_name }}"
        min_count: 1
      register: group_info


    - name: Setup - Server information
      clc_server_fact:
        server_id: "{{ group_info.group.servers[0] }}"
      register: server_info

    - name: Setup - Ensure snapshots absent
      clc_server_snapshot:
        server_ids:
          - "{{ server_info.server.id }}"
        state: absent
        wait: True
      register: snapshot_absent


    - name: Test - Create snapshot
      clc_server_snapshot:
        server_ids:
          - "{{ server_info.server.id }}"
        state: present
        expiration_days: 1
        wait: True
      register: snapshot_create
    - name: Test - Ensure snapshot created
      assert:
        that:
          - snapshot_create.changed == True

    - name: Test - Ensure snapshot present
      clc_server_snapshot:
        server_ids:
          - "{{ server_info.server.id }}"
        state: present
        expiration_days: 1
        wait: True
      register: snapshot_present
    - name: Test - Ensure snapshot present
      assert:
        that:
          - snapshot_present.changed == False

    - name: Test - Restore from snapshot
      clc_server_snapshot:
        server_ids:
          - "{{ server_info.server.id }}"
        state: restore
        wait: True
      register: snapshot_restore
    - name: Test - Ensure snapshot restored
      assert:
        that:
          - snapshot_restore.changed == True


    - name: Tear Down - Delete snapshot
      clc_server_snapshot:
        server_ids:
          - "{{ server_info.server.id }}"
        state: absent
        wait: True
      register: snapshot_delete
    - name: Test - Ensure snapshot deleted
      assert:
        that:
          - snapshot_delete.changed == True


    - name: Tear Down - Ensure 0 servers exist in group
      clc_server:
        name: "{{ server_name }}"
        template: "{{ server_template }}"
        location: "{{ location }}"
        group: "{{ group_name }}"
        count_group: "{{ group_name }}"
        exact_count: 0

    - name: Tear Down - Ensure group absent
      clc_group:
        location: "{{ location }}"
        name: "{{ group_name }}"
        state: absent
