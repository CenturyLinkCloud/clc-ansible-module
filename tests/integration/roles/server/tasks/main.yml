---
- name: server create
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    count: 1
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    type: 'hyperscale'
    storage_type: 'hyperscale'
    ttl: 7200
    add_public_ip: True
    public_ip_protocol: TCP
    public_ip_ports: 443
    anti_affinity_policy_name: "{{ aa_policy_name }}"
    alert_policy_name: "{{ alert_policy_name }}"
    wait: True
  register: server_create
- name: assert server create
  assert:
    that:
      - server_create.changed == True
      - server_create.group.serversCount == 1

- name: server start unchanged
  clc_server:
    location: "{{ location }}"
    server_ids: "{{ server_create.server_ids }}"
    state: started
    wait: True
  register: server_start_unchanged
- name: assert server start unchanged
  assert:
    that:
      - server_start_unchanged.servers[0].details.powerState == 'started'
      - server_start_unchanged.changed == False

- name: server stop
  clc_server:
    location: "{{ location }}"
    server_ids: "{{ server_create.server_ids }}"
    state: stopped
    wait: True
  register: server_stop
- name: assert server stop
  assert:
    that:
      - server_stop.servers[0].details.powerState == 'stopped'
      - server_stop.changed == True

- name: server stop unchanged
  clc_server:
    location: "{{ location }}"
    server_ids: "{{ server_create.server_ids }}"
    state: stopped
    wait: True
  register: server_stop_unchanged
- name: assert server stop unchanged
  assert:
    that:
      - server_stop_unchanged.servers[0].details.powerState == 'stopped'
      - server_stop_unchanged.changed == False

- name: server start restart
  clc_server:
    location: "{{ location }}"
    server_ids: "{{ server_create.server_ids }}"
    state: started
    wait: True
  register: server_start_restart
- name: assert server start restart
  assert:
    that:
      - server_start_restart.servers[0].details.powerState == 'started'
      - server_start_restart.changed == True

- name: server minimum count
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    min_count: 4
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    type: 'hyperscale'
    storage_type: 'hyperscale'
    ttl: 7200
    wait: True
  register: server_minimum_count
- name: assert server minimum count
  assert:
    that:
      - server_minimum_count.changed == True
      - server_minimum_count.group.serversCount == 4

- name: server maximum count
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    max_count: 3
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    ttl: 7200
    wait: True
  register: server_maximum_count
- name: assert server maximum count
  assert:
    that:
      - server_maximum_count.changed == True
      - server_maximum_count.group.serversCount == 3

- name: server exact count
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    exact_count: 2
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    ttl: 7200
    wait: True
  register: server_exact_count
- name: assert server exact count
  assert:
    that:
      - server_exact_count.changed == True
      - server_exact_count.group.serversCount == 2

- name: set servers_fact
  set_fact:
    servers_fact: servers_exact_count.servers

- name: server exact count unchanged
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    exact_count: 2
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    ttl: 7200
    wait: True
  register: server_exact_count_unchanged
- name: assert server exact count unchanged
  assert:
    that:
      - server_exact_count_unchanged.changed == False

- name: server maximum count unchanged
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    max_count: 3
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    ttl: 7200
    wait: True
  register: server_maximum_count_unchanged
- name: assert server maximum count unchanged
  assert:
    that:
      - server_maximum_count_unchanged.changed == False

- name: server minimum count unchanged
  clc_server:
    location: "{{ location }}"
    name: "{{ server_name }}"
    template: "{{ server_template }}"
    min_count: 1
    group: "{{ group_name }}"
    count_group: "{{ group_name }}"
    cpu: 1
    memory: 1
    ttl: 7200
    wait: True
  register: server_minimum_count_unchanged
- name: assert server minimum count unchanged
  assert:
    that:
      - server_minimum_count_unchanged.changed == False
