# Copyright 2016 CenturyLink
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Test clc_modify_server.py Ansible Module
  hosts: localhost
  vars:
    location: 'CA3'
    server_template: 'CENTOS-7-64-TEMPLATE'
    group_name: 'Ansible Module Test'
    server_name: 'AnsTst'
    policy_name: 'Ansible Module Test Policy'
  gather_facts: False
  connection: local
  tasks:
    - name: Setup - Ensure group present
      clc_group:
        location: "{{ location }}"
        name: "{{ group_name }}"
        state: present

    - name: Setup - Ensure 1 server exist in group
      clc_server:
        name: "{{ server_name }}"
        template: "{{ server_template }}"
        location: "{{ location }}"
        group: "{{ group_name }}"
        count_group: "{{ group_name }}"
        type: hyperscale
        storage_type: hyperscale
        cpu: 1
        memory: 1
        min_count: 1
      register: group_info

    - name: Setup - Server information
      clc_server_fact:
        server_id: "{{ group_info.group.servers[0] }}"
      register: server_info

    - name: Get network list
      clc_network_fact:
        location: "{{ location }}"
      register: network_list

    - name: Setup - Anti-Affinity Policy Present
      clc_aa_policy:
        name: "{{ policy_name }}"
        location: "{{ location }}"
        state: present
      register: policy_aa_present

    - name: Setup - Alert Policy Present
      clc_alert_policy:
        name: "{{ policy_name }}"
        alert_recipients:
          - test1@centurylink.com
        metric: 'cpu'
        duration: '00:10:00'
        threshold: 95
        state: present
      register: policy_alert_present


    - name: Setup - Server State
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        cpu: 1
        memory: 1
        state: present
        wait: True

    - name: Setup - Server Policies
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        alert_policy_name: "{{ policy_name }}"
        anti_affinity_policy_name: "{{ policy_name }}"
        additional_network: "{{ network_list.networks[0].id }}"
        state: absent
        wait: True



    - name: Test - Modify CPU
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        cpu: 2
        state: present
        wait: True
      register: modify_cpu
    - name: Assert - CPU Changed
      assert:
        that:
          - modify_cpu.changed == True

    - name: Test - Modify Memory
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        memory: 2
        state: present
        wait: True
      register: modify_memory
    - name: Assert - Memory Changed
      assert:
        that:
          - modify_memory.changed == True

    - name: Test - Modify Check
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        cpu: 2
        memory: 2
        state: present
        wait: True
      register: modify_check
    - name: Assert - Memory Changed
      assert:
        that:
          - modify_check.changed == False

    - name: Test - Add Alert Policy
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        alert_policy_name: "{{ policy_name }}"
        state: present
        wait: True
      register: modify_alert_policy
    - name: Assert - Policy Added
      assert:
        that:
          - modify_alert_policy.changed == True

    - name: Test - Add Anti Affinity Policy
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        anti_affinity_policy_name: "{{ policy_name }}"
        state: present
        wait: True
      register: modify_aa_policy
    - name: Assert - Policy changed
      assert:
        that:
          - modify_aa_policy.changed == True

    - name: Test - Modify network
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        additional_network: "{{ network_list.networks[0].id }}"
        state: present
        wait: True
      register: modify_check

    - name: Test - Ensure policies and network present
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        alert_policy_name: "{{ policy_name }}"
        anti_affinity_policy_name: "{{ policy_name }}"
        additional_network: "{{ network_list.networks[0].id }}"
        state: present
        wait: True
      register: modify_check
    - name: Assert - No Change
      assert:
        that:
          - modify_check.changed == False

    - name: Test - Remove Policies and Network
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        alert_policy_name: "{{ policy_name }}"
        anti_affinity_policy_name: "{{ policy_name }}"
        additional_network: "{{ network_list.networks[0].id }}"
        state: absent
        wait: True
      register: modify_remove
    - name: Assert - Server Changed
      assert:
        that:
          - modify_remove.changed == True

    - name: Test - Ensure Removed
      clc_modify_server:
        server_ids:
          - "{{ server_info.server.id }}"
        location: "{{ location }}"
        alert_policy_name: "{{ policy_name }}"
        anti_affinity_policy_name: "{{ policy_name }}"
        additional_network: "{{ network_list.networks[0].id }}"
        state: absent
        wait: True
      register: modify_check
    - name: Assert - No Change
      assert:
        that:
          - modify_check.changed == False



    - name: Test - Remove server
      clc_server:
        location: "{{ location }}"
        server_id: "{{ server_info.server.id }}"
        state: absent
        wait: True
      register: server_remove

    - name: Teardown - Remove group
      clc_group:
        location: "{{ location }}"
        name: "{{ server_group }}"
        state: absent
        wait: True
      register: group_remove
