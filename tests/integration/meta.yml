# Copyright 2016 CenturyLink
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Test clc_meta.py Ansible Module
  hosts: localhost
  vars:
    meta_name: 'Ansible Module Test'
    description: 'Test metadata for ansible module'
    ref_id: 'abcd1234-abcd-1234-5678-abcd12345678'
    job_id: '12345678-1234-5678-abcd-12345678abcd'
    exec_id: '5678abcd-5678-abcd-1234-5678abcd1234'
    instance_create: "CA3WFTCANSTST00"
    instance_update: "CA3WFTCANSTST99"
  gather_facts: False
  connection: local
  tasks:
    - name: Setup - Verify meta absent
      clc_meta:
        state: absent
        name: "{{ meta_name }}"
        description: "{{ description }}"
        jobId: "{{ job_id }}"
        executionId: "{{ exec_id }}"
        referenceId: "{{ ref_id }}"
        data:
          type: INSTANCE
          value: "{{ instance_create }}"
      register: meta_absent


    - name: Test - Create meta
      clc_meta:
        state: present
        name: "{{ meta_name }}"
        description: "{{ description }}"
        jobId: "{{ job_id }}"
        executionId: "{{ exec_id }}"
        referenceId: "{{ ref_id }}"
        data:
          type: INSTANCE
          value: "{{ instance_create }}"
      register: meta_create
    - name: Assert - Meta created
      assert:
        that:
          - meta_create.changed == True
          - meta_create.content.state == "created"

    - name: Test - Update meta
      clc_meta:
        state: present
        name: "{{ meta_name }}"
        description: "{{ description }}"
        jobId: "{{ job_id }}"
        executionId: "{{ exec_id }}"
        referenceId: "{{ ref_id }}"
        data:
          type: INSTANCE
          value: "{{ instance_update }}"
      register: meta_update
    - name: Assert - Meta updated
      assert:
        that:
          - meta_update.changed == True
          - meta_update.content.state == "updated"

    - name: Test - Metadata Fact
      clc_meta_fact:
        name: "{{ meta_name }}"
        jobId: "{{ job_id }}"
        executionId: "{{ exec_id }}"
        referenceId: "{{ ref_id }}"
      register: meta_fact
    - name: Assert - Meta Facts
      assert:
        that:
          - meta_fact.changed == False
          - meta_fact.content.data.metadata[0].data.value == "{{ instance_update }}"

    - name: Test - Delete meta
      clc_meta:
        state: absent
        name: "{{ meta_name }}"
        description: "{{ description }}"
        jobId: "{{ job_id }}"
        executionId: "{{ exec_id }}"
        referenceId: "{{ ref_id }}"
        data:
          type: INSTANCE
          value: "{{ instance_update }}"
      register: meta_delete
    - name: Assert - Meta created
      assert:
        that:
          - meta_delete.changed == True
          - meta_delete.content.state == "deleted"


    - name: Test - Ensure meta absent
      clc_meta:
        state: absent
        name: "{{ meta_name }}"
        description: "{{ description }}"
        jobId: "{{ job_id }}"
        executionId: "{{ exec_id }}"
        referenceId: "{{ ref_id }}"
        data:
          type: INSTANCE
          value: "{{ instance_update }}"
      register: meta_absent
    - name: Assert - Meta created
      assert:
        that:
          - meta_absent.changed == False
          - meta_absent.content.state == "absent"

